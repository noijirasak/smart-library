<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>หนังสือพูดได้ | Smart Library</title>
  <style>
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,'Segoe UI',Roboto,'Noto Sans Thai',Arial,sans-serif;color:#0f172a;background:#f8fafc}
    .container{max-width:980px;margin:0 auto;padding:24px}
    header{text-align:center;margin-bottom:16px}
    h1{margin:8px 0 0;font-size:2rem}
    .subtitle{margin:4px 0 0;color:#475569}
    .book{display:grid;grid-template-columns:320px 1fr;gap:24px;background:#fff;padding:24px;border-radius:16px;box-shadow:0 10px 24px rgba(2,6,23,.08)}
    .cover{width:100%;height:auto;border-radius:12px;box-shadow:0 6px 16px rgba(2,6,23,.1);background:#e2e8f0}
    .meta p{line-height:1.6;margin:6px 0}
    .audio{margin-top:12px}
    .audio h2{margin:8px 0;font-size:1.1rem}
    .note{font-size:.9rem;color:#64748b}
    .err{background:#fee2e2;border:1px solid #ef4444;color:#7f1d1d;padding:12px;border-radius:12px}
    @media (max-width:760px){.book{grid-template-columns:1fr}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
</head>
<body>
  <main class="container">
    <header>
      <h1 id="page-title">กำลังโหลดข้อมูลหนังสือ...</h1>
      <p class="subtitle">ใส่ <code>?id=เลขลำดับ</code> (และถ้ารู้หมวด ใส่ <code>&cat=000</code> หรือ 100,…,900)</p>
    </header>

    <section class="book" id="book-section" style="display:none">
      <img id="cover" class="cover" alt="ปกหนังสือ"/>
      <div class="meta">
        <p><strong>ชื่อหนังสือ:</strong> <span id="title"></span></p>
        <p><strong>ผู้แต่ง:</strong> <span id="author"></span></p>
        <p><strong>เลขหมวดหมู่:</strong> <span id="category"></span></p>
        <p><strong>คะแนน:</strong> <span id="score"></span></p>
        <p><strong>คำอธิบาย:</strong> <span id="description"></span></p>

        <div class="audio">
          <h2>เสียงบรรยายบทนำ</h2>
          <audio id="audio" controls>เบราว์เซอร์ของคุณไม่รองรับการเล่นเสียง</audio>
          <p class="note">* โหลดจากคอลัมน์ <code>audio_url</code> (ต้องเป็นลิงก์สาธารณะ)</p>
        </div>
      </div>
    </section>

    <section id="error" class="err" style="display:none"></section>
  </main>

  <script>
  (function(){
    // --- ตั้งค่าชีตของคุณ ---
    const SHEET_ID  = "1agyu31GI2YGD-42in3P7hZytsKNO-kg-JDdfvlJL7q0";
    const SHEET_TABS = ["000","100","200","300","400","500","600","700","800","900"];

    // --- อ้างอิง element ---
    const $ = id => document.getElementById(id);
    const els = {
      pageTitle: $("page-title"),
      bookSection: $("book-section"),
      error: $("error"),
      cover: $("cover"),
      title: $("title"),
      author: $("author"),
      category: $("category"),
      description: $("description"),
      score: $("score"),
      audio: $("audio"),
    };

    // --- รับพารามิเตอร์ ---
    const params = new URLSearchParams(location.search);
    const id  = (params.get("id")  || "").trim();  // เลขในคอลัมน์ "ลำดับ"
    const cat = (params.get("cat") || "").trim();  // 000/100/.../900 (ถ้ามี)

    if(!id){
      return showError('กรุณาระบุ <code>?id=เลขลำดับ</code> ใน URL เช่น <code>?id=1</code>');
    }

    // สร้างลิงก์ CSV ต่อแผ่นงาน
    const csvUrl = (tab) =>
      `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tab)}`;

    // ลำดับการค้นหา: ถ้ามี cat ให้หาแผ่นนั้นก่อน แล้วค่อยที่เหลือ
    const order = (() => {
      if(!cat) return SHEET_TABS.slice();
      const preferred = cat; // เพราะคุณตั้งชื่อแท็บเป็นตัวเลขล้วน
      return [preferred, ...SHEET_TABS.filter(t => t !== preferred)];
    })();

    // โหลดจากทีละแผ่นงาน จนกว่าจะเจอ row ที่ลำดับตรง id
    (async () => {
      try{
        let found = null;
        for(const tab of order){
          const row = await loadOneTab(tab);
          if(row){ found = row; break; }
        }
        if(!found) return showError(`ไม่พบหนังสือ ลำดับ = ${id} ในแท็บใด ๆ`);
        render(found);
      }catch(e){
        showError("โหลดข้อมูลผิดพลาด: " + e);
      }
    })();

    function loadOneTab(tab){
      return new Promise((resolve, reject) => {
        Papa.parse(csvUrl(tab), {
          download: true,
          header: true,
          skipEmptyLines: true,
          complete: (res) => {
            const rows = res.data || [];
            const match = rows.find(r => (String(r["ลำดับ"]||"").trim() === id));
            resolve(match || null);
          },
          error: (err) => reject(err)
        });
      });
    }

    function render(b){
      setText(els.pageTitle, b["ชื่อหนังสือ"] || "ไม่ทราบชื่อ");
      setText(els.title,      b["ชื่อหนังสือ"] || "");
      setText(els.author,     b["ผู้แต่ง"]      || "");
      setText(els.category,   b["เลขหมวดหมู่"]  || "");
      setText(els.description,b["คำอธิบาย"]     || "");
      setText(els.score,      b["คะแนน"]        || "-");

      if(b["รูปปก"])    els.cover.src = b["รูปปก"];
      if(b["audio_url"]) els.audio.src = b["audio_url"];

      els.bookSection.style.display = "grid";
    }

    function setText(el, v){ if(el) el.textContent = v; }
    function showError(msg){
      setText(els.pageTitle, "เกิดข้อผิดพลาด");
      els.error.style.display = "block";
      els.error.innerHTML = msg;
    }
  })();
  </script>
</body>
</html>
